<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 项目</title>
    
    <!-- A-Frame 核心库 -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- AR.js 库 -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .font-inter {
            font-family: 'Inter', sans-serif;
        }
        .bg-primary {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="font-inter bg-gray-900 text-white overflow-hidden h-screen">
    <a-scene 
      vr-mode-ui="enabled: false" 
      renderer="colorManagement: true, logarithmicDepthBuffer: true"
      arjs="sourceType: webcam; debugUIEnabled: true;"
      cursor="rayOrigin: mouse">
      
      <!-- 相机 + 光标 -->
      <a-entity camera look-controls>
        <a-entity 
          cursor="fuse: false; rayOrigin: mouse" 
          raycaster="objects: [data-raycastable]"
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
          material="color: cyan; shader: flat">
        </a-entity>
      </a-entity>
      
      <!-- 标记和3D模型 -->
      <a-marker preset="hiro">
        <a-entity 
          id="ar-model"
          data-raycastable
          gltf-model="#robotModel" 
          scale="0.01 0.01 0.01"
          position="0 0 0"
          rotation="0 180 0"
          animation="property: rotation; to: 0 540 0; loop: true; dur: 10000; easing: linear"
          click-listener>
        </a-entity>
      </a-marker>
      
      <a-assets>
        <a-asset-item id="robotModel" src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF/Duck.gltf"></a-asset-item>
      </a-assets>
    </a-scene>
    
    <!-- 信息面板 -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-black/70 backdrop-blur z-50">
        <div class="text-center">
            <h3 class="text-lg font-semibold mb-2">AR 体验</h3>
            <p class="text-sm text-gray-300">将手机屏幕上的 Hiro 标记对准电脑摄像头</p>
            <div id="cameraStatus" class="text-xs text-yellow-400 mt-1">
                <i class="fa fa-camera mr-1"></i>正在初始化摄像头...
            </div>
        </div>
    </div>
    
    <!-- 标记卡提示 -->
    <div id="markerHint" class="fixed top-0 left-0 right-0 bottom-0 bg-black/80 backdrop-blur z-40 flex items-center justify-center">
        <div class="bg-white/10 backdrop-blur rounded-lg p-6 max-w-md mx-4 text-center">
            <div class="mb-4">
                <h2 class="text-xl font-bold mb-2">准备开始 AR 体验</h2>
                <p class="text-gray-300">请按以下步骤操作：</p>
                <ol class="text-left text-sm text-gray-300 mt-2 space-y-1">
                    <li>1. 在手机上打开 Hiro 标记图片</li>
                    <li>2. 将手机屏幕对准电脑摄像头</li>
                    <li>3. 保持手机屏幕稳定，等待识别</li>
                </ol>
            </div>
            <div class="relative w-32 h-32 mx-auto mb-4">
                <img src="https://jeromeetienne.github.io/AR.js/data/images/hiro.png" 
                     alt="Hiro Marker" 
                     class="w-full h-full object-contain border-2 border-white/20 rounded-lg">
            </div>
            <div class="mb-4 text-center">
                <p class="text-xs text-gray-400 mb-2">或者扫描二维码在手机上打开</p>
                <div class="w-24 h-24 mx-auto bg-white p-2 rounded">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=96x96&data=https://jeromeetienne.github.io/AR.js/data/images/hiro.png" 
                         alt="QR Code" 
                         class="w-full h-full">
                </div>
            </div>
            <div class="flex gap-2 justify-center">
                <button onclick="showMarkerFullscreen()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg">
                    <i class="fa fa-expand mr-2"></i>全屏显示标记
                </button>
                <button onclick="testAR()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg">
                    <i class="fa fa-play mr-2"></i>测试AR功能
                </button>
                <button onclick="checkCamera()" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg">
                    <i class="fa fa-camera mr-2"></i>检查摄像头
                </button>
                <button onclick="showCameraFeed()" 
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg">
                    <i class="fa fa-eye mr-2"></i>查看摄像头画面
                </button>
                <a href="https://jeromeetienne.github.io/AR.js/data/images/hiro.png" 
                   target="_blank"
                   class="px-4 py-2 bg-primary text-white rounded-lg">
                    <i class="fa fa-mobile-alt mr-2"></i>在手机上打开标记
                </a>
            </div>
        </div>
    </div>
    
    <script>
      // 请求摄像头权限
      async function requestCameraPermission() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          });
          console.log('摄像头权限已获取');
          return true;
        } catch (error) {
          console.error('摄像头权限被拒绝:', error);
          alert('需要摄像头权限才能使用AR功能。请允许摄像头访问。');
          return false;
        }
      }

      // 等待 A-Frame 加载完成
      document.addEventListener('DOMContentLoaded', async function() {
        // 请求摄像头权限
        await requestCameraPermission();
        // 注册点击交互组件
        AFRAME.registerComponent('click-listener', {
          init: function() {
            this.el.addEventListener('click', (e) => {
              // 点击时暂停自动旋转，改为手动控制
              this.el.removeAttribute('animation');
              // 添加缩放动画反馈
              this.el.setAttribute('animation__scale', {
                property: 'scale',
                from: '0.01 0.01 0.01',
                to: '0.015 0.015 0.015',
                dur: 300,
                easing: 'easeOutElastic',
                dir: 'alternate'
              });
            });
          }
        });
    
        // 模型旋转控制（触摸屏适用）
        const model = document.getElementById('ar-model');
        let isDragging = false;
        let startX, startY;
        let startRotationY = 0;
    
        model.addEventListener('mousedown', (e) => {
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          startRotationY = model.getAttribute('rotation').y;
        });
    
        window.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          const deltaX = e.clientX - startX;
          model.setAttribute('rotation', `0 ${startRotationY + deltaX * 0.5} 0`);
        });
    
        window.addEventListener('mouseup', () => isDragging = false);
        
        // 隐藏标记提示当检测到标记时
        const scene = document.querySelector('a-scene');
        scene.addEventListener('markerFound', function() {
          document.getElementById('markerHint').style.display = 'none';
        });
        
        // 添加AR状态检测
        scene.addEventListener('camera-init', function() {
          console.log('AR摄像头已初始化');
          document.getElementById('markerHint').style.display = 'flex';
          document.getElementById('cameraStatus').innerHTML = '<i class="fa fa-camera mr-1"></i>摄像头已就绪';
          document.getElementById('cameraStatus').className = 'text-xs text-green-400 mt-1';
        });
        
        scene.addEventListener('camera-error', function(error) {
          console.error('AR摄像头错误:', error);
          document.getElementById('cameraStatus').innerHTML = '<i class="fa fa-exclamation-triangle mr-1"></i>摄像头初始化失败';
          document.getElementById('cameraStatus').className = 'text-xs text-red-400 mt-1';
          alert('AR摄像头初始化失败，请检查摄像头权限和浏览器支持。');
        });
        
        // 添加标记检测事件
        scene.addEventListener('markerFound', function() {
          console.log('✅ 检测到Hiro标记！');
          document.getElementById('markerHint').style.display = 'none';
          document.getElementById('cameraStatus').innerHTML = '<i class="fa fa-check mr-1"></i>标记已识别';
          document.getElementById('cameraStatus').className = 'text-xs text-green-400 mt-1';
        });
        
        scene.addEventListener('markerLost', function() {
          console.log('❌ 失去Hiro标记');
          document.getElementById('markerHint').style.display = 'flex';
          document.getElementById('cameraStatus').innerHTML = '<i class="fa fa-camera mr-1"></i>等待标记...';
          document.getElementById('cameraStatus').className = 'text-xs text-yellow-400 mt-1';
        });
        
        // 添加调试信息
        console.log('AR场景已加载，等待摄像头初始化...');
        
        // 延迟检测AR.js系统
        setTimeout(() => {
          const scene = document.querySelector('a-scene');
          if (scene) {
            const arSystem = scene.systems['arjs'];
            if (arSystem) {
              console.log('✅ AR.js系统已成功加载');
              document.getElementById('cameraStatus').innerHTML = '<i class="fa fa-check mr-1"></i>AR系统就绪';
              document.getElementById('cameraStatus').className = 'text-xs text-green-400 mt-1';
            } else {
              console.log('❌ AR.js系统仍未加载');
              document.getElementById('cameraStatus').innerHTML = '<i class="fa fa-exclamation-triangle mr-1"></i>AR系统未加载';
              document.getElementById('cameraStatus').className = 'text-xs text-red-400 mt-1';
              
              // 尝试备用方案
              console.log('尝试备用AR方案...');
              if (window.AFRAME) {
                console.log('AFRAME可用，尝试手动注册AR组件');
              }
            }
          }
        }, 2000);
        
        // 测试AR功能
        window.testAR = function() {
          console.log('测试AR功能...');
          const scene = document.querySelector('a-scene');
          if (scene) {
            console.log('AR场景存在');
            
            // 检查AR.js系统
            const arSystem = scene.systems['arjs'];
            if (arSystem) {
              console.log('AR.js系统已加载');
              console.log('AR配置:', arSystem.arProfile);
              
              // 检查摄像头流
              if (arSystem.arProfile && arSystem.arProfile.sourceParameters) {
                console.log('摄像头参数:', arSystem.arProfile.sourceParameters);
              }
            } else {
              console.log('AR.js系统未找到');
            }
            
            // 检查摄像头
            const camera = scene.querySelector('[camera]');
            if (camera) {
              console.log('摄像头实体存在');
              // 检查摄像头是否有视频纹理
              const videoTexture = camera.getAttribute('material')?.src;
              if (videoTexture) {
                console.log('摄像头视频纹理存在');
              } else {
                console.log('摄像头视频纹理不存在');
              }
            } else {
              console.log('摄像头实体不存在');
            }
            
            // 检查标记
            const marker = scene.querySelector('a-marker');
            if (marker) {
              console.log('标记实体存在');
              console.log('标记预设:', marker.getAttribute('preset'));
            } else {
              console.log('标记实体不存在');
            }
            
            // 检查3D模型
            const model = document.getElementById('ar-model');
            if (model) {
              console.log('3D模型存在');
              const modelSrc = model.getAttribute('gltf-model');
              console.log('模型源:', modelSrc);
            } else {
              console.log('3D模型不存在');
            }
          } else {
            console.log('AR场景未找到');
          }
        };
        
        // 显示摄像头画面
        window.showCameraFeed = function() {
          console.log('显示摄像头画面...');
          
          // 创建摄像头画面显示窗口
          const feedDiv = document.createElement('div');
          feedDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 300px;
            background: #000;
            border: 2px solid #fff;
            border-radius: 8px;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
          `;
          
          feedDiv.innerHTML = `
            <div style="text-align: center;">
              <div style="margin-bottom: 10px;">摄像头画面预览</div>
              <video id="cameraFeed" autoplay muted style="max-width: 100%; max-height: 100%;"></video>
              <div style="margin-top: 10px;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="padding: 5px 10px; background: #f00; color: white; border: none; border-radius: 4px; cursor: pointer;">
                  关闭
                </button>
              </div>
            </div>
          `;
          
          document.body.appendChild(feedDiv);
          
          // 获取摄像头流
          navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
              const video = document.getElementById('cameraFeed');
              video.srcObject = stream;
              console.log('摄像头画面已显示');
            })
            .catch(function(error) {
              console.error('无法显示摄像头画面:', error);
              feedDiv.innerHTML = `
                <div style="text-align: center; color: red;">
                  无法访问摄像头<br>
                  ${error.message}
                  <br><br>
                  <button onclick="this.parentElement.parentElement.remove()" 
                          style="padding: 5px 10px; background: #f00; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    关闭
                  </button>
                </div>
              `;
            });
        };
        
        // 检查摄像头功能
        window.checkCamera = function() {
          console.log('检查摄像头功能...');
          
          // 检查是否有摄像头权限
          navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
              console.log('✅ 摄像头权限正常');
              console.log('摄像头轨道:', stream.getVideoTracks());
              
              // 获取摄像头信息
              const videoTrack = stream.getVideoTracks()[0];
              if (videoTrack) {
                const capabilities = videoTrack.getCapabilities();
                console.log('摄像头能力:', capabilities);
                
                const settings = videoTrack.getSettings();
                console.log('摄像头设置:', settings);
              }
              
              // 停止流
              stream.getTracks().forEach(track => track.stop());
            })
            .catch(function(error) {
              console.error('❌ 摄像头权限错误:', error);
              alert('摄像头权限被拒绝或不可用: ' + error.message);
            });
        };
        
        // 全屏显示标记功能
        window.showMarkerFullscreen = function() {
          const markerUrl = 'https://jeromeetienne.github.io/AR.js/data/images/hiro.png';
          const fullscreenDiv = document.createElement('div');
          fullscreenDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            cursor: pointer;
          `;
          
          const img = document.createElement('img');
          img.src = markerUrl;
          img.style.cssText = `
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border: 2px solid white;
            border-radius: 8px;
          `;
          
          fullscreenDiv.appendChild(img);
          document.body.appendChild(fullscreenDiv);
          
          // 点击关闭全屏
          fullscreenDiv.addEventListener('click', function() {
            document.body.removeChild(fullscreenDiv);
          });
        };
      });
    </script>
</body>
</html>